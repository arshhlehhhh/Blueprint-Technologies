<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- The above 4 meta tags *must* come first in the head; any other head content must come *after* these tags -->

    <!-- Title -->
    <title>Blue Print Technologies</title>

    <!-- Favicon -->
    <link rel="icon" href="img/core-img/favicon.ico">

    <!-- Stylesheet -->
    <link rel="stylesheet" href="style.css">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- jquery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://kit.fontawesome.com/b1b5f42ae7.js" crossorigin="anonymous"></script>
    <style>
        #scenariodata {
            display: none;
        }

        .fas.fa-chevron-down {
            font-size: 25px;
            color: gray;
            transition: all 0.2s linear;
        }

        .fas.fa-chevron-down.down {
            transform: scaleY(-1);
        }

        button {
            border: none;
            background: none;
        }

        button:focus {
            outline: none;
        }
    </style>
</head>

<body>
    <!--#### Register Modal Start ####-->
    <div class="modal fade" id="registerModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Register Account</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input class="form-control" id="register_name" type="text" placeholder="Name"><br>
                    <input class="form-control" id="register_username" type="text" placeholder="Username"><br>
                    <input class="form-control" id="register_password" type="password" placeholder="Password"><br>
                    <input class="form-control" id="register_confirm_password" type="password"
                        placeholder="Confirm Password">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="registerAccount()">Register</button>
                </div>
            </div>
        </div>
    </div>
    </div>
    <!--#### Register Modal End ####-->

    <!--#### Log In Modal Start ####-->
    <div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Register Account</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input class="form-control" id="login_username" type="text" placeholder="Username"><br>
                    <input class="form-control" id="login_password" type="password" placeholder="Password"><br>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="loginAccount()">Log In</button>
                </div>
            </div>
        </div>
    </div>
    </div>
    <!--#### Log In Modal End ####-->

    <!-- Preloader -->
    <div class="preloader d-flex align-items-center justify-content-center">
        <div class="lds-ellipsis">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
    </div>

    <!-- ##### Header Area Start ##### -->
    <header class="header-area">
        <!-- Top Header Area -->
        <div class="top-header-area">
            <div class="container h-100">
                <div class="row h-100 align-items-center">
                    <div class="col-12 d-flex justify-content-between">
                        <!-- Logo Area -->
                        <div class="logo">
                            <a href="index.html"><img src="img/core-img/logo.png" alt="" style="height:17%;"></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navbar Area -->
        <div class="credit-main-menu" id="sticker">
            <div class="classy-nav-container breakpoint-off">
                <div class="container">
                    <!-- Menu -->
                    <nav class="classy-navbar justify-content-between" id="creditNav">

                        <!-- Navbar Toggler -->
                        <div class="classy-navbar-toggler">
                            <span class="navbarToggler"><span></span><span></span><span></span></span>
                        </div>

                        <!-- Menu -->
                        <div class="classy-menu">

                            <!-- Close Button -->
                            <div class="classycloseIcon">
                                <div class="cross-wrap"><span class="top"></span><span class="bottom"></span></div>
                            </div>

                            <!-- Nav Start -->
                            <div class="classynav">
                                <ul>
                                    <li><a href="index.html">Home</a></li>
                                    <li><a href="about.html">About Us</a></li>
                                    <li><a href="decipher_news.html">Decipher News</a></li>
                                    <li><a href="demo_account.html">Demo Account</a></li>
                                    <li><a href="peer_benchmarking.html">Peer Benchmarking</a></li>
                                    <li><a href="glossary.html">Glossary</a></li>
                                    
                                </ul>
                            </div>
                            <!-- Nav End -->
                        </div>

                        <!-- Contact -->
                        <div class="contact">
                            <button id="login_btn" type="button" style="margin-top:15%;" class="btn btn-info"
                                data-toggle="modal" data-target="#loginModal">Log In</button>
                            <button id="register_btn" type="button" style="margin-top:15%;" class="btn btn-primary"
                                data-toggle="modal" data-target="#registerModal">Register</button>


                            <button id="logout_btn" type="button" style="margin-top:4%;" class="btn btn-danger"
                                onclick="logout()">Logout</button>
                            <img id="profile_picture" src="img/core-img/profile_icon.png"
                                style="width:7%;margin-top:4%;border-radius:50%;;" alt="Avatar">
                        </div>
                    </nav>
                </div>
            </div>
        </div>
    </header>
    <!-- ##### Header Area End ##### -->

    <!-- ##### Breadcrumb Area Start ##### -->
    <section class="breadcrumb-area bg-img bg-overlay jarallax" style="background-image: url(img/bg-img/13.jpg);">
        <div class="container h-100" style="padding:0;">
            <div class="row h-100 align-items-center">
                <div class="col-12">
                    <div class="breadcrumb-content">
                        <h2>Demo Account</h2>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- ##### Breadcrumb Area End ##### -->


    <!-- ##### Services Area Start ###### -->
    <section class="services-area">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <!-- Section Heading -->
                    <div class="section-heading text-center">
                        <div class="line"></div>
                        <p>The key to</p>
                        <h2>Investing</h2>
                    </div>
                </div>
            </div>
            <div class="row container-fluid d-flex justify-content-center">
                <p class="p-0 m-0">View Scenario</p>
            </div>
            <div class="row container-fluid d-flex justify-content-center">
                <button class="p-0 m-0" id="viewscenario"><i class="fas fa-chevron-down"></i></button>
            </div>
            <div class="row container-fluid" id="scenariodata">
                <div class="row container-fluid"><strong>Scenario Number: </strong><strong id="scenarionum"></strong>
                </div>
                <div class="row container-fluid">
                    <p id="scenariodetails"></p>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-4">
                    <!-- Donut Chart -->
                    <div id="donutchart" style="width: 400px; height: 230px;">Loading...</div>
                </div>
                <div class="col-sm-8">
                    <!-- Line Graph -->

                    <body>
                        <div id="curve_chart" style="width:550 px; height: 250px"></div>
                    </body>
                </div>
            </div>

            <div class="row">
                <!-- #### Column 1 #### -->
                <div class="col-12">
                    <div class="row container-fluid">
                        <h3>Stocks</h3>
                        <strong class="ml-auto my-auto text-bottom">Account Balance : $</strong><text class="my-auto"
                            id="balance"></text>
                    </div>
                    <form onsubmit="executeTrade()">
                        <div class="row container-fluid">
                            <table class="table">
                                <thead class="thead-dark">
                                    <tr>
                                        <th></th>
                                        <th>Ticker</th>
                                        <th>Name</th>
                                        <th>Current Holdings</th>
                                        <th>Price</th>
                                        <th>Action</th>
                                        <th>Quantity</th>
                                    </tr>
                                </thead>
                                <tbody id="stockInfo">
                                    <tr>
                                        <td>Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="row container-fluid d-flex justify-content-center">
                            <input class="btn btn-primary" type="submit" value="Trade!">
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>
    <!-- ##### Services Area End ###### -->

    <!-- ##### Footer Area Start ##### -->
    <footer class="footer-area section-padding-100-0">

        <!-- Copywrite Area -->
        <div class="copywrite-area">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <div class="copywrite-content d-flex flex-wrap justify-content-between align-items-center">
                            <!-- Footer Logo -->
                            <a href="index.html" class="footer-logo"><img src="img/core-img/logo.png" alt=""
                                    style="height:90px;"></a>

                            <!-- Copywrite Text -->
                            <p class="copywrite-text"><a href="#">
                                    <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
                                    Copyright &copy;<script>
                                        document.write(new Date().getFullYear());
                                    </script> All rights reserved by Blueprint Technologies
                                    <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    <!-- ##### Footer Area Start ##### -->

    <!-- ##### All Javascript Script ##### -->
    <!-- jQuery-2.2.4 js -->
    <script src="js/jquery/jquery-2.2.4.min.js"></script>
    <!-- Popper js -->
    <script src="js/bootstrap/popper.min.js"></script>
    <!-- Bootstrap js -->
    <script src="js/bootstrap/bootstrap.min.js"></script>
    <!-- All Plugins js -->
    <script src="js/plugins/plugins.js"></script>
    <!-- Active js -->
    <script src="js/active.js"></script>

    <!-- #### Register Script Start #### -->
    <script>
        $('#viewscenario').click(function () {
            $("#scenariodata").slideToggle();
            $(".fas.fa-chevron-down").toggleClass("down");
            return false;
        });




        var globalJson;
        var globalHoldings;
        var globalBalance;
        var globalTickerPrice;
        google.charts.load('current', {
            'packages': ['corechart']
        });
        google.charts.setOnLoadCallback(drawGraph);

        function drawGraph() {
            var data = google.visualization.arrayToDataTable([
                ['Quarter', '-'],
                ['', 0]
            ]);

            var options = {
                title: 'Historical Price',
                curveType: 'function',
                legend: {
                    position: 'bottom'
                }
            };

            var chart = new google.visualization.LineChart(document.getElementById('curve_chart'));

            chart.draw(data, options);
        }

        function toggleGraph(ticker) {
            var options = {
                title: 'Historical Price',
                vAxis: {
                    format: 'decimal'
                },
                curveType: 'function',
                legend: {
                    position: 'bottom'
                }
            };
            var chartdata = new google.visualization.DataTable();
            chartdata.addColumn('string', 'Quarter');
            chartdata.addColumn('number', ticker);
            // var chartdata = google.visualization.arrayToDataTable([
            //     ['Quarter', ticker]
            // ]);
            var endDate = globalJson["demoDetails"]["endDate"]
            var url = "http://107.21.167.79:5004/stocks/retrieveQuarter/" + ticker + "/" + endDate;
            var chart = new google.visualization.LineChart(document.getElementById('curve_chart'));
            $.get(url, function (data) {
                Object.keys(data).forEach(function (key) {
                    chartdata.addRow([key, data[key]]);
                });


                chart.draw(chartdata, options);
            });
        }


        var user = sessionStorage.getItem("loggedin_user")
        var acctUrl = "http://107.21.167.79:5003/DemoGame/startDemo/" + user
        var jsonData = $.get(acctUrl, function (dataJSON) {
            $('#scenarionum').append(dataJSON["demoDetails"]["scenerio_id"]);
            $('#scenariodetails').append(dataJSON["demoDetails"]["message"]);


            $('#balance').append(dataJSON["demoUser"]["balance"]);
            globalBalance = dataJSON["demoUser"]["balance"]
            globalJson = dataJSON;
            var holdingsByCat = {}
            var sumOfHoldings = 0;
            var holdingsDict = {}
            var tickerPrice = {}
            var holdingsArray = dataJSON["demoUser"]["holding"].split(";")
            console.log(dataJSON["demoUser"]["holding"])
            holdingsArray.forEach(function (item, index) {
                var eachHolding = item.split(":")

                holdingsDict[eachHolding[0]] = eachHolding[1]
            });
            globalHoldings = holdingsDict
            var stockChoices = "";
            var stocksJson = dataJSON['stocks'];
            Object.keys(stocksJson).forEach(function (key) {
                for (i = 0; i < stocksJson[key].length; i++) {
                    var currText = "<tr><td><input type='radio' onClick=toggleGraph('" + stocksJson[key]
                        [i]['ticker'] + "') name='chartToggle'></td>"
                    currText += "<td>" + stocksJson[key][i]['ticker'] + "</td>"
                    currText += "<td>" + key + ": " + stocksJson[key][i]['name'] + "</td>"
                    if (stocksJson[key][i]['ticker'] in holdingsDict) {
                        currText += "<td>" + holdingsDict[stocksJson[key][i]['ticker']] + "</td>"
                        if (stocksJson[key][i]['ticker'] in holdingsByCat) {
                            holdingsByCat[key] += holdingsDict[stocksJson[key][i]['ticker']] *
                                stocksJson[key][i]['price']
                        } else {
                            holdingsByCat[key] = holdingsDict[stocksJson[key][i]['ticker']] *
                                stocksJson[key][i]['price']
                        }
                        sumOfHoldings += holdingsDict[stocksJson[key][i]['ticker']] * stocksJson[key][i]
                            ['price']
                    } else {
                        currText += "<td>0</td>"
                    }

                    currText += "<td>" + stocksJson[key][i]['price'] + "</td>"
                    currText += "<td><input type='radio' name='" +
                        stocksJson[key][i]['ticker'] + "' id='buy' value='" + stocksJson[
                            key][i]['ticker'] +
                        "buy'> Buy <input type='radio' name='" +
                        stocksJson[key][i]['ticker'] + "' id='sell' value='" +
                        stocksJson[key][i]['ticker'] + "sell'> Sell </td>"
                    currText += "<td><input type='text' name='" + stocksJson[key][i]['ticker'] +
                        "'></input></td></tr>"
                    stockChoices += currText
                    tickerPrice[stocksJson[key][i]['ticker']] = stocksJson[key][i]['price']
                }
                globalTickerPrice = tickerPrice
            })
            $('#stockInfo').html($.parseHTML(stockChoices))

            console.log(holdingsByCat)
            var cashOnHand = dataJSON["demoUser"]["balance"] - sumOfHoldings
            var chartDataTable = [
                ['Category', 'Holdings']
            ]
            Object.keys(holdingsByCat).forEach(function (key) {
                chartDataTable.push([key, holdingsByCat[key]])
            });
            chartDataTable.push(['Cash', cashOnHand])

            function drawChart() {
                var data = google.visualization.arrayToDataTable(chartDataTable);

                var options = {
                    title: 'My Portfolio',
                    pieHole: 0.4,
                };

                var chart = new google.visualization.PieChart(document.getElementById('donutchart'));
                chart.draw(data, options);
            }
            google.charts.setOnLoadCallback(drawChart);
            alert("Data Loaded Successfully!");
        })

        $("form").on("submit", function (e) {
            e.preventDefault()
        });

        function executeTrade() {
            var formData = $("form").serializeArray();
            var buyList = {}
            var sellList = {}
            for (i = 0; i < formData.length; i++) {
                if (formData[i]['value'] != "") {
                    if (formData[i]['value'].endsWith("buy")) {
                        buyList[formData[i]['name']] = 0
                    } else if (formData[i]['value'].endsWith("sell")) {
                        sellList[formData[i]['name']] = 0
                    } else if (formData[i]['name'] in buyList) {
                        buyList[formData[i]['name']] = formData[i]['value']
                    } else {
                        sellList[formData[i]['name']] = formData[i]['value']
                    }
                }
            }
            var oldHoldings = globalHoldings
            currBalance = globalBalance
            Object.keys(oldHoldings).forEach(function (key) {
                if (key in buyList) {
                    oldHoldings[key] += buyList[key]
                    currBalance -= globalTickerPrice[key] * buyList[key]
                } else if (key in sellList) {
                    oldHoldings[key] -= sellList[key]
                    currBalance += globalTickerPrice[key] * sellList[key]
                }
            });
            Object.keys(buyList).forEach(function (key) {
                if (!(key in oldHoldings)) {
                    oldHoldings[key] = buyList[key]
                    currBalance -= globalTickerPrice[key] * buyList[key]
                }
            });
            
            var holdingString = ""
            Object.keys(oldHoldings).forEach(function (key) {
                if (key in globalTickerPrice) {
                    holdingString += key + ":" + oldHoldings[key] + ";"
                    // if (oldHoldings[key] > 0) {
                    //     currBalance -= oldHoldings[key] * globalTickerPrice[key]
                    // } else {
                    //     currBalance += oldHoldings[key] * globalTickerPrice[key]
                    // }
                }
            });
            holdingString = holdingString.slice(0, -1)
            newScenarioId = globalJson["demoDetails"]["scenerio_id"]
            returnString = {
                "scenerio_id": newScenarioId,
                "balance": currBalance,
                "holding": holdingString
            }
            returnString = JSON.stringify(returnString)
            postURL = "http://107.21.167.79:5002/accountdemo/save_status/" + user
            // $.post(postURL, returnString).done(function (data) {
            //     alert("done");
            // });
            $.ajax({
                url: postURL,
                type: "POST",
                crossDomain: true,
                headers: {
                    'Content-Type': 'application/json'
                },
                data: returnString,
                dataType: "json",
                success: function (response) {
                    alert("done");
                    location.reload(); 
                },
                error: function (xhr, status) {
                    alert("error");
                    location.reload(); 
                }
            });
            return false
        }


        function showError(message) {
            $("#error").remove();
            $('#errormsg-container').append("<label id='error'>" + message + "</label>");
        }


        async function registerAccount() {
            var username = document.getElementById("register_username").value;
            var password = document.getElementById("register_password").value;
            var confirm_password = document.getElementById("register_confirm_password").value;
            var name = document.getElementById("register_name").value;
            var serviceURL = "http://107.21.167.79:5001/account/" + username

            if (password == confirm_password) {
                // localStorage.email = customer.email;
                try {
                    const response =
                        await fetch(
                            serviceURL, {
                                method: 'POST',
                                headers: {
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify({
                                    password: password,
                                    name: name
                                })
                            }
                        );
                    const data = await response.json();
                    var customer = data;
                    location.reload();
                    alert("Account Registered!");
                    $('#registerModal').modal('hide');
                } catch (error) {
                    showError('There is a problem retrieving customer data, please try again later.<br />' + error);
                }

            } else {
                showError('Passwords do not match!');
            }
            location.reload();
            $('#registerModal').modal('hide');
        }

        async function loginAccount() {
            var username = document.getElementById("login_username").value;
            var password = document.getElementById("login_password").value;
            var serviceURL = "http://107.21.167.79:5001/account/authenticate/" + username

            try {
                const response =
                    await fetch(
                        serviceURL, {
                            method: 'POST',
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                password: password
                            })
                        }
                    );

                const data = await response.json();
                var customer = data;
                location.reload();
                alert("Logged in!");
                $('#loginModal').modal('hide');
                sessionStorage.setItem("loggedin_user", username);


            } catch (error) {
                showError('There is a problem retrieving customer data, please try again later.<br />' + error);
            }
            location.reload();
            $('#loginModal').modal('hide');
            sessionStorage.setItem("loggedin_user", username);
        }

        loggedin_user = sessionStorage.getItem("loggedin_user");

        if (loggedin_user != null) {
            var loginbtn = document.getElementById('login_btn');
            loginbtn.style.display = "none";

            var registerbtn = document.getElementById('register_btn');
            registerbtn.style.display = "none";

        } else {
            var profilepicture = document.getElementById('profile_picture');
            profilepicture.style.display = "none";

            var logoutbtn = document.getElementById('logout_btn');
            logoutbtn.style.display = "none";
        }

        function logout() {
            alert("You have been logged out!");
            sessionStorage.removeItem('loggedin_user');
            location.reload();
        }
    </script>
</body>

</html>